<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Aqua"><meta name="description" content="updateViewConstraints与updateConstraints简介updateViewConstraints与updateConstraints是AutoLayout出现后新增的api，updateConstraints主要功能是更新view的约束,并会调用其所有"><meta name="keywords" content="iOS,Swift,AutoLayout"><title>-updateViewConstraints与-updateConstraints · Aqua's Blog</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2016/12/02/updateConstraints/"><link rel="alternate" href="/atom.xml" title="Aqua's Blog"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Aqua's Blog</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">-updateViewConstraints与-updateConstraints</h1><span class="post-time">Dec 2, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#updateViewConstraints与updateConstraints简介"><span class="toc-text">updateViewConstraints与updateConstraints简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-use-updateConstraints"><span class="toc-text">How to use updateConstraints?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于UIView的translatesAutoresizingMaskIntoConstraints属性"><span class="toc-text">关于UIView的translatesAutoresizingMaskIntoConstraints属性</span></a></li></ol></div><div class="post-content"><h2 id="updateViewConstraints与updateConstraints简介"><a href="#updateViewConstraints与updateConstraints简介" class="headerlink" title="updateViewConstraints与updateConstraints简介"></a><code>updateViewConstraints</code>与<code>updateConstraints</code>简介</h2><p><code>updateViewConstraints</code>与<code>updateConstraints</code>是<code>AutoLayout</code>出现后新增的<code>api</code>，<code>updateConstraints</code>主要功能是更新<code>view</code>的约束,并会调用其所有子视图的该方法去更新约束。</p>
<a id="more"></a>
<p>而<code>updateViewConstraints</code>的出现方便了<code>viewController</code>，不用专门去重写<code>controller</code>的<code>view</code>，当<code>view</code>的<code>updateConstraints</code>被调用时，该<code>view</code>若有<code>controller</code>，该<code>controller</code>的<code>updateViewConstraints</code>便会被调用。</p>
<p>两个方法都需要在方法实现的最后调用父类的该方法。并且这两个方法不建议直接调用。</p>
<p>在使用过程中我发现这两个方法有时候不会被系统调用。后来我看到<code>public class func requiresConstraintBasedLayout() -&gt; Bool</code>方法的描述：</p>
<blockquote>
<p>constraint-based layout engages lazily when someone tries to use it (e.g., adds a constraint to a view).  If you do all of your constraint set up in -updateConstraints, you might never even receive updateConstraints if no one makes a constraint.  To fix this chicken and egg problem, override this method to return YES if your view needs the window to use constraint-based layout.  </p>
</blockquote>
<p>大意是说，视图并不是主动采用<code>constraint-based</code>的。在非<code>constraint-based</code>的情况下<code>-updateConstraints</code>,可能一次都不会被调用，解决这个问题需要重写该类方法并返回true。</p>
<p>这里要注意，如果一个<code>view</code>或<code>controller</code>是由interface builder初始化的，那么这个实例的<code>updateViewConstraints</code>或<code>updateConstraints</code>方法便会被系统自动调用，起原因应该就是对应的<code>requiresConstraintBasedLayout</code>方法返回<code>true</code>。而纯代码初始化的视图<code>requiresConstraintBasedLayout</code>方法默认返回<code>false</code>。</p>
<p>所以在纯代码自定义一个<code>view</code>时，想把约束写在<code>updateConstraints</code>方法中，就一定要重写<code>requiresConstraintBasedLayout</code>方法，返回<code>true</code>。</p>
<p>至于纯代码写的<code>viewController</code>如何让其<code>updateViewConstraints</code>方法被调用。我自己的解决办法是手动调用其<code>view</code>的<code>setNeedsUpdateConstraints</code>方法。</p>
<h2 id="How-to-use-updateConstraints"><a href="#How-to-use-updateConstraints" class="headerlink" title="How to use updateConstraints?"></a>How to use updateConstraints?</h2><p>文档中对于这两个方法提的最多的就是，重写这两个方法，在里面设置约束。所以一开始我认为这两个方法是苹果提供给我们专门写约束的。于是便开始尝试使用。</p>
<p>直到后来在<code>UIView</code>中看到这样一句话：</p>
<blockquote>
<p>You should only override this method when changing constraints in place is too slow, or when a view is producing a number of redundant changes.</p>
</blockquote>
<p>“你只因该在添加约束过于慢的时候，或者一次要修改大量约束的情况下重写次方法。”</p>
<p>简直是让人觉得又迷茫又坑爹。<code>updateConstraints</code>方法到底应该何时使用</p>
<p>后来看到<a href="http://oleb.net/blog/2015/08/how-to-use-updateconstraints/" target="_blank" rel="external">how to use updateConstraints</a>这篇文章。给出了一个合理的解释：</p>
<ul>
<li><p>尽量将约束的添加写到类似于viewDidLoad的方法中。</p>
</li>
<li><p><code>updateConstraints</code>并不应该用来给视图添加约束，它更适合用于周期性地更新视图的约束，或者在添加约束过于消耗性能的情况下将约束写到该方法中。</p>
</li>
<li><p>当我们在响应事件时（例如点击按钮时）对约束的修改如果写到<code>updateConstraints</code>中，会让代码的可读性非常差。</p>
</li>
</ul>
<p>关于性能，我也做了一个简单的测试：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MMView</span>: <span class="title">UIView</span> </span>&#123;</div><div class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</div><div class="line">        <span class="keyword">self</span>.backgroundColor = <span class="type">UIColor</span>.grayColor()</div><div class="line">        initManyButton()</div><div class="line">        <span class="comment">//初始化时添加约束</span></div><div class="line">        test() <span class="comment">//每次只有一个test()不被注释就好</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesBegan</span><span class="params">(touches: Set&lt;UITouch&gt;, withEvent event: UIEvent?)</span></span> &#123;</div><div class="line">        <span class="comment">//响应事件时添加约束</span></div><div class="line">        <span class="comment">//test()</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">updateConstraints</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">//updateConstraints中添加约束</span></div><div class="line">        <span class="comment">//test()</span></div><div class="line">        <span class="keyword">super</span>.updateConstraints()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">let</span> then = <span class="type">CFAbsoluteTimeGetCurrent</span>()</div><div class="line">        addConstraintsToButton()</div><div class="line">        <span class="keyword">let</span> now = <span class="type">CFAbsoluteTimeGetCurrent</span>()</div><div class="line">        <span class="built_in">print</span>(now - then)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> buttonTag = <span class="number">200</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">initManyButton</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0</span>...<span class="number">1000</span>&#123;</div><div class="line">            <span class="keyword">let</span> button = <span class="type">UIButton</span>(type: .<span class="type">System</span>)</div><div class="line">            button.tag = buttonTag + index</div><div class="line">            <span class="keyword">self</span>.addSubview(button)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addConstraintsToButton</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0</span>...<span class="number">1000</span>&#123;</div><div class="line">            <span class="keyword">if</span> <span class="keyword">let</span> button = <span class="keyword">self</span>.viewWithTag(index+buttonTag)&#123;</div><div class="line">                button.snp_makeConstraints&#123; make <span class="keyword">in</span></div><div class="line">                    make.center.equalTo(<span class="keyword">self</span>)</div><div class="line">                    make.size.equalTo(<span class="keyword">self</span>)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>分别对 将 设置约束 写在<code>init</code>中、写在<code>updateConstraints</code>中、写在事件响应方法中 的时间消耗进行测试，对1000个button添加约束，每个添加4个约束。</p>
<ul>
<li><code>init</code>中,时间消耗约为0.37秒</li>
<li>写在<code>updateconstraints</code>中，时间消耗约为0.52秒</li>
<li>写在事件响应方法中，时间消耗约为0.77秒</li>
</ul>
<p><strong>所以，结论，还是将约束的设置写在<code>viewDidLoad</code>中或者<code>init</code>中。没事儿尽量不去碰<code>updateConstraints</code>。除非对性能有要求。</strong></p>
<h2 id="关于UIView的translatesAutoresizingMaskIntoConstraints属性"><a href="#关于UIView的translatesAutoresizingMaskIntoConstraints属性" class="headerlink" title="关于UIView的translatesAutoresizingMaskIntoConstraints属性"></a>关于UIView的translatesAutoresizingMaskIntoConstraints属性</h2><p>最近在对<code>AutoLayout</code>的学习中发现，很多人似乎对<code>translatesAutoresizingMaskIntoConstraints</code>的误解非常大，很多时候遇到问题总有人会在下面回答到：把<code>translatesAutoresizingMaskIntoConstraints</code>设置成<code>false</code>就可以解决问题。。。实际上并没有什么用。</p>
<p>那么这个属性到底是做什么的呢？</p>
<p>其实这个属性的命名已经把这个属性的功能解释的非常清楚了。</p>
<p>除了<code>AutoLayout</code>，<code>AutoresizingMask</code>也是一种布局方式。这个想必大家都有了解。默认情况下，<code>translatesAutoresizingMaskIntoConstraints ＝ true</code> , 此时视图的<code>AutoresizingMask</code>会被转换成对应效果的约束。这样很可能就会和我们手动添加的其它约束有冲突。此属性设置成<code>false</code>时，<code>AutoresizingMask</code>就不会变成约束。也就是说 <code>当前</code> 视图的 <code>AutoresizingMask</code>失效了。</p>
<p><strong>那我们什么时候需要设置这个属性呢？</strong></p>
<p><strong>当我们用代码添加视图时</strong>,视图的<code>translatesAutoresizingMaskIntoConstraints</code>属性默认为<code>true</code>，可是<code>AutoresizingMask</code>属性默认会被设置成<code>.None</code>。也就是说如果我们不去动<code>AutoresizingMask</code>，那么<code>AutoresizingMask</code>就不会对约束产生影响。</p>
<p><strong>当我们使用interface builder添加视图时</strong>，<code>AutoresizingMask</code>虽然会被设置成<code>非.None</code>，但是<code>translatesAutoresizingMaskIntoConstraints</code>默认被设置成了<code>false</code>。所以也不会有冲突。</p>
<p>反而有的视图是靠<code>AutoresizingMask</code>布局的，当我们修改了<code>translatesAutoresizingMaskIntoConstraints</code>后会让视图失去约束，走投无路。例如我自定义转场时就遇到了这样的问题，转场后的视图并不在视图的正中间。</p>
<p><strong>所以，这个属性，基本上我们也不用设置它。</strong></p>
</div></article><div class="tags"><a href="/tags/iOS/">iOS</a><a href="/tags/Swift/">Swift</a><a href="/tags/AutoLayout/">AutoLayout</a></div><div class="paginator"><a id="prev" href="/2016/12/03/app环境变量/" data-title="用xcconfig文件配置iOSapp环境变量" class="prev"><i class="iconfont icon-left"></i><span>Prev</span></a><a id="next" href="/2016/12/01/运用泛型实现不重用的UITableView/" data-title="运用泛型实现不重用的UITableView" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://yoursite.com/2016/12/02/updateConstraints/index.html" data-title="-updateViewConstraints与-updateConstraints" data-url="http://yoursite.com/2016/12/02/updateConstraints/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "mangomade" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="social"><a href="mailto:781132399@qq.com" title="email" class="iconfont icon-email"></a><a href="https://MangoMade.github.com" title="github" class="iconfont icon-github"></a><a href="/atom.xml" title="rss" class="iconfont icon-rss"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2017<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Aqua</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>